<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace = "we.are.Mapper.StoreMapper">
<!--  해시맵을 이용해서 join값을 알맞게 넘기기 -->
<resultMap type="java.util.HashMap" id="store_select"> 
		<result column="uuid" property="uuid" />
		<result column="cname" property="cname" />
		<result column="pproduct" property="pproduct" />
		<result column="ocount" property="ocount" />
		<result column="tcount" property="tcount" />
		<result column="osuju" property="osuju" />
		<result column="otext" property="otext" />
		<result column="x" property="x" />
		<result column="y" property="y" />	
		<result column="sdel" property="sdel" />	
		<result column="pcode" property="pcode" />	
		<result column="oday" property="oday" />	
		<result column="pstock" property="pstock" />	
		<result column="pcount" property="pcount" />	
		<result column="ono" property="ono" />	
		<result column="pprice" property="pprice" />	
</resultMap>
		<!-- resultMap ='store_select' 같은 resultMap을 찾아서 실행  -->
		
<!--  osuju가 "수주 확인"인것만 List 뽑기 -->
<select id="store_select" resultMap="store_select"> 
select a.ono,uuid,osuju,a.cname,otext,pcount,oday,pcount,pproduct 
from orderr a join connection b join cart c 
on a.cname = b.cname and a.ono = c.ono  
where osuju = "수주 확인" order by a.ono asc limit 1;
</select>

<!-- 수주상태가 '출고 요청 '인 것 리스트의 갯수 -->
<select id="storerelease_count" resultType="int"> 
select count(*) from orderr a join connection b on a.cname = b.cname  where osuju = "출고 요청" order by a.ono asc;
</select>

<!--  osuju가 "출고 요청"인것만 List 뽑기 -->
<select id="storerelease_select" resultMap="store_select"> 
select a.ono, oday, uuid, osuju, a.cname, pcode, pstock, c.pproduct, ocount, pcount, tcount 
from orderr a join product b join cart c  
on b.pname = c.pproduct and c.ono = a.ono 
where osuju = "출고 요청" order by a.ono asc limit 1;
</select>


<!-- 장바구니 조인 -->
<select id="product_select" resultMap="store_select">
select cname, pproduct, pcode,ocount,b.pprice from orderr a join cart b join product c on a.ono = b.ono and  b.pproduct = c.pname where a.ono = #{ono};
</select>

<select id="product_List" resultMap="store_select">
select pproduct, pcode,pstock,ocount,amount from orderr a join cart b join product c on a.ono = b.ono and  b.pproduct = c.pname where a.ono = #{ono};
</select>

<select id="management_select" resultMap="store_select"> 
select  amount,a.ono, oday, pcode, sdate, uuid, a.cname,pproduct,ocount,scount,osuju,otext,x,y,sdel   
from orderr a join connection b join product c on  a.cname = b.cname and a.pproduct = c.pname
where osuju = "견적서 발행" order by a.ono asc; 
</select>


<update id="balju_update">
update orderr ord ,cart car , product pro 
set pro.pstock = (select afpstock from (select (pstock - #{ocount}) afpstock where pcode = #{uuid})as afpstock),
 ord.sdate= now(),
 ord.tcount = #{scount},
 ord.osuju = '출고 요청',
 ord.sdel ='출고 중',
 car.amount = (select afamount from(select (amount + #{amount}) afamount from cart where pproduct = #{pproduct} and ono = #{ono})as afamount)
where car.ono = #{ono} and pcode = #{uuid};

</update>
<!-- 발주 체크 -->
<select id="balju_check" resultType="String">
select sdate from orderr where ono = #{ono};
</select>

<!-- 수주상태 변경 -> '견적서 발행' -->
<update id="osuju_update">
update orderr set osuju = "견적서 발행" where ono =#{ono};
</update>

<select id="check" resultMap="store_select"> 
select  amount,a.ono, oday, pcode, sdate, uuid, a.cname,pproduct,ocount,scount,osuju,otext,x,y,sdel   
from orderr a join connection b join product c on  a.cname = b.cname and a.pproduct = c.pname order by a.ono asc; 
</select>

<select id="issuance_select" resultMap="store_select"> 
select  amount,a.ono, oday, pcode, sdate, uuid, a.cname,pproduct,ocount,scount,osuju,otext,x,y,sdel   
from orderr a join connection b join product c on  a.cname = b.cname and a.pproduct = c.pname
where osuju = "출고 요청 확인" and ono = #{ono} order by a.ono asc; 
</select>





</mapper>